<div class="bulk-unit-page">
  <!-- Header -->
  <header class="bulk-unit-page__header">
    <button class="bulk-unit-page__back-btn" (click)="goBack()" type="button">
      <i class="bi bi-arrow-left"></i>
    </button>
    <div class="bulk-unit-page__header-content">
      <div class="bulk-unit-page__icon-container">
        <i class="bi bi-buildings"></i>
      </div>
      <h1 class="bulk-unit-page__title">Gestión de Unidades</h1>
      <p class="bulk-unit-page__subtitle">Crea y administra las unidades de tu organización</p>
    </div>
  </header>

  <!-- Content -->
  <div class="bulk-unit-page__content">
    <!-- Loading Config -->
    @if (isLoadingConfig()) {
      <div class="bulk-unit-page__loading">
        <div class="bulk-unit-page__spinner"></div>
        <p>Cargando configuración...</p>
      </div>
    }

    <!-- General Error -->
    @if (generalError()) {
      <div class="bulk-unit-page__error" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        {{ generalError() }}
      </div>
    }

    <!-- Form / Result -->
    @if (!isLoadingConfig()) {
      
      <!-- Add Button -->
      @if (!showForm() && !distributionResult()) {
        <div class="bulk-unit-page__actions">
          <button class="btn-add-units" (click)="toggleForm()">
            <i class="bi bi-plus-circle"></i> 
            Agregar nuevas unidades
          </button>
        </div>
      }

      @if (showForm() || distributionResult()) {
        @if (distributionResult()) {
          <app-distribution-result
            [result]="distributionResult()!"
            (createMore)="handleCreateMore()" />
        } @else {
          <div class="bulk-unit-page__config-badge">
            <i class="bi bi-info-circle"></i>
            Máximo permitido: <strong>{{ maxUnitsAllowed() }}</strong> unidades por lote
          </div>

          <app-bulk-unit-form
            [isSubmitting]="isSubmitting()"
            [maxAllowed]="maxUnitsAllowed()"
            (formSubmit)="handleSubmit($event)"
            (formCancel)="handleCancel()" />
        }
      }

      <!-- Units Preview -->
      @if (isLoadingUnits()) {
        <div class="bulk-unit-page__loading">
          <div class="bulk-unit-page__spinner"></div>
          <p>Cargando unidades...</p>
        </div>
      }

      @if (!isLoadingUnits() && groupedUnits().length > 0) {
        <section class="units-preview" aria-labelledby="preview-title">
          <h2 id="preview-title" class="units-preview__title">Unidades Existentes</h2>
          
          <div class="units-preview__container">
            @for (group of groupedUnits(); track group.type) {
              <div class="units-preview__group">
                <h3 class="units-preview__group-title">{{ translateType(group.type) }}</h3>
                <div class="units-preview__grid">
                  @for (unit of group.units; track unit.id) {
                    <button 
                      class="units-preview__card" 
                      [class.units-preview__card--active]="unit.isActive"
                      [class.units-preview__card--occupied]="isOccupied(unit)"
                      (click)="openUnitDetail(unit)"
                      type="button"
                      [attr.aria-label]="'Ver detalle de unidad ' + unit.code">
                      <span class="units-preview__card-code">{{ unit.code }}</span>
                      @if (isOccupied(unit)) {
                        <span class="units-preview__card-badge">
                          <i class="bi bi-person-fill"></i>
                        </span>
                      }
                    </button>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Legend -->
          <div class="units-preview__legend">
            <div class="units-preview__legend-item">
              <span class="units-preview__legend-dot units-preview__legend-dot--available"></span>
              Disponible
            </div>
            <div class="units-preview__legend-item">
              <span class="units-preview__legend-dot units-preview__legend-dot--occupied"></span>
              Ocupada
            </div>
          </div>
        </section>
      }

      @if (!isLoadingUnits() && groupedUnits().length === 0 && !isLoadingConfig()) {
        <div class="bulk-unit-page__empty">
          <i class="bi bi-building-x"></i>
          <p>No hay unidades creadas aún</p>
          <p class="bulk-unit-page__empty-hint">Usa el botón de arriba para agregar unidades</p>
        </div>
      }
    }
  </div>

  <!-- Unit Detail Modal -->
  <app-unit-detail-modal
    [visible]="showUnitModal()"
    [unit]="selectedUnit()"
    (closeModal)="closeUnitModal()" />

  <!-- Bottom Navigation -->
  <app-admin-bottom-nav [activeTab]="'more'" />
</div>
