<div class="bulk-unit-page">
  <!-- Header -->
  <header class="bulk-unit-page__header">
    <button class="bulk-unit-page__back-btn" (click)="goBack()" type="button">
      <i class="bi bi-arrow-left"></i>
    </button>
    <div class="bulk-unit-page__header-content">
      <div class="bulk-unit-page__icon-container">
        <i class="bi bi-buildings"></i>
      </div>
      <h1 class="bulk-unit-page__title">Generación Masiva</h1>
      <p class="bulk-unit-page__subtitle">Crea múltiples unidades de forma rápida</p>
    </div>
  </header>

  <!-- Content -->
  <div class="bulk-unit-page__content">
    <!-- Loading Config -->
    @if (isLoadingConfig()) {
      <div class="bulk-unit-page__loading">
        <div class="bulk-unit-page__spinner"></div>
        <p>Cargando configuración...</p>
      </div>
    }

    <!-- General Error -->
    @if (generalError()) {
      <div class="bulk-unit-page__error" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        {{ generalError() }}
      </div>
    }

    <!-- Form / Result -->
    @if (!isLoadingConfig()) {
      
      <!-- Add Button -->
      @if (!showForm() && !distributionResult()) {
        <div class="bulk-unit-page__actions">
          <button class="btn-add-units" (click)="toggleForm()">
            <i class="bi bi-plus-circle"></i> 
            Agregar nuevas unidades
          </button>
        </div>
      }

      @if (showForm() || distributionResult()) {
        @if (distributionResult()) {
          <app-distribution-result
            [result]="distributionResult()!"
            (createMore)="handleCreateMore()" />
        } @else {
          <div class="bulk-unit-page__config-badge">
            <i class="bi bi-info-circle"></i>
            Máximo permitido: <strong>{{ maxUnitsAllowed() }}</strong> unidades por lote
          </div>

          <app-bulk-unit-form
            [isSubmitting]="isSubmitting()"
            [maxAllowed]="maxUnitsAllowed()"
            (formSubmit)="handleSubmit($event)"
            (formCancel)="handleCancel()" />
        }
      }

      <!-- Units Preview -->
      @if (!isLoadingUnits() && groupedUnits().length > 0) {
        <section class="units-preview" aria-labelledby="preview-title">
          <h2 id="preview-title" class="units-preview__title">Unidades Existentes</h2>
          
          <div class="units-preview__container">
            @for (group of groupedUnits(); track group.type) {
              <div class="units-preview__group">
                <h3 class="units-preview__group-title">{{ group.type }}</h3>
                <div class="units-preview__grid">
                  @for (unit of group.units; track unit.id) {
                    <div 
                      class="units-preview__card" 
                      [class.units-preview__card--active]="unit.isActive"
                      [title]="unit.status">
                      {{ unit.code }}
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </section>
      }
    }
  </div>

  <!-- Bottom Navigation -->
  <app-admin-bottom-nav [activeTab]="'more'" />
</div>
