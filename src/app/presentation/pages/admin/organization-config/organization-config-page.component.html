<div class="org-config">
  <!-- Header -->
  <header class="org-config__header">
    <button class="org-config__back-btn" (click)="goBack()" type="button" aria-label="Volver">
      <i class="bi bi-arrow-left"></i>
    </button>
    <div class="org-config__header-content">
      <div class="org-config__icon-container">
        <i class="bi bi-gear"></i>
      </div>
      <h1 class="org-config__title">Configuración</h1>
      <p class="org-config__subtitle">Ajustes de tu organización</p>
    </div>
  </header>

  <!-- Content -->
  <div class="org-config__content">
    <!-- Loading -->
    @if (isLoading()) {
      <div class="org-config__loading">
        <div class="org-config__spinner"></div>
        <p>Cargando configuración...</p>
      </div>
    }

    <!-- Success Message -->
    @if (successMessage()) {
      <output class="org-config__alert org-config__alert--success">
        <i class="bi bi-check-circle-fill"></i>
        {{ successMessage() }}
      </output>
    }

    <!-- General Error -->
    @if (generalError()) {
      <div class="org-config__alert org-config__alert--error" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        {{ generalError() }}
      </div>
    }

    <!-- Config Form -->
    @if (!isLoading()) {
      <form class="org-config__form" [formGroup]="form" (ngSubmit)="onSave()">
        <!-- Units Section -->
        <div class="org-config__section">
          <div class="org-config__section-header">
            <i class="bi bi-buildings"></i>
            <h2 class="org-config__section-title">Generación de Unidades</h2>
          </div>

          <div class="org-config__card">
            <div class="org-config__item">
              <div class="org-config__info">
                <label for="maxUnitsPerDistribution" class="org-config__label">Máximo de unidades por lote</label>
                <p class="org-config__description">Número máximo de unidades que se pueden crear en una sola operación de generación masiva.</p>
              </div>
              <div class="org-config__control">
                <input
                  id="maxUnitsPerDistribution"
                  formControlName="maxUnitsPerDistribution"
                  type="number"
                  class="org-config__input"
                  min="1"
                  max="1000"
                  [class.org-config__input--error]="form.get('maxUnitsPerDistribution')?.touched && form.get('maxUnitsPerDistribution')?.invalid" />
                @if (getErrorMessage('maxUnitsPerDistribution')) {
                  <span class="org-config__field-error">{{ getErrorMessage('maxUnitsPerDistribution') }}</span>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Owner Permission Management Section -->
        <div class="org-config__section">
          <div class="org-config__section-header">
            <i class="bi bi-shield-lock"></i>
            <h2 class="org-config__section-title">Permisos de Residentes</h2>
          </div>

          <div class="org-config__card">
            <div class="org-config__item org-config__item--toggle">
              <div class="org-config__info">
                <label class="org-config__label">Administración de permisos por propietario</label>
                <p class="org-config__description">Si está activo, los propietarios podrán seleccionar qué permisos otorgar a los residentes que inviten. Si está inactivo, los residentes heredarán los mismos permisos del propietario.</p>
              </div>
              <div class="org-config__control">
                <app-toggle-switch
                  [checked]="form.get('enableOwnerPermissionManagement')?.value"
                  (toggled)="form.get('enableOwnerPermissionManagement')?.setValue($event); hasChanges.set(true)"
                  ariaLabel="Habilitar administración de permisos por propietario" />
              </div>
            </div>
          </div>
        </div>

        <!-- Branding Section -->
        <div class="org-config__section">
          <div class="org-config__section-header">
            <i class="bi bi-palette"></i>
            <h2 class="org-config__section-title">Identidad Visual</h2>
          </div>

          <div class="org-config__card">
            <!-- Logo Upload -->
            <div class="org-config__item">
              <div class="org-config__info">
                <label for="logoUpload" class="org-config__label">Logo de la organización</label>
                <p class="org-config__description">Carga el logo o ícono de tu organización. Formatos aceptados: PNG, JPG. Tamaño máximo: 2MB.</p>
              </div>

              <div class="org-config__logo-upload">
                @if (logoPreview()) {
                  <div class="org-config__logo-preview">
                    <img [src]="logoPreview()" alt="Logo de la organización" />
                  </div>
                }

                <label for="logoUpload" class="org-config__upload-btn">
                  <i class="bi bi-cloud-arrow-up"></i>
                  {{ logoPreview() ? 'Cambiar imagen' : 'Seleccionar imagen' }}
                </label>
                <input
                  id="logoUpload"
                  type="file"
                  accept="image/png,image/jpeg"
                  class="org-config__file-input"
                  (change)="onLogoSelected($event)" />

                @if (logoError()) {
                  <span class="org-config__field-error">{{ logoError() }}</span>
                }
              </div>
            </div>

            <!-- Extracting colors indicator -->
            @if (isExtractingColors()) {
              <div class="org-config__item org-config__extracting">
                <div class="org-config__spinner-sm"></div>
                <span>Extrayendo colores de la imagen...</span>
              </div>
            }

            <!-- Color Pickers -->
            <div class="org-config__item">
              <div class="org-config__info">
                <label class="org-config__label">Colores del tema</label>
                <p class="org-config__description">Personaliza los colores de tu organización. Se autocompletan al cargar un logo, pero puedes editarlos manualmente.</p>
              </div>

              <div class="org-config__color-pickers">
                <div class="org-config__color-field">
                  <label for="dominantColor" class="org-config__color-label">Dominante (60%)</label>
                  <div class="org-config__color-input-group">
                    <input
                      type="color"
                      [value]="form.get('dominantColor')?.value || '#B01129'"
                      (input)="onColorPickerChange('dominantColor', $event)"
                      class="org-config__color-swatch" />
                    <input
                      id="dominantColor"
                      formControlName="dominantColor"
                      type="text"
                      class="org-config__color-text"
                      placeholder="#B01129"
                      maxlength="7"
                      [class.org-config__input--error]="form.get('dominantColor')?.touched && form.get('dominantColor')?.invalid" />
                  </div>
                  @if (getErrorMessage('dominantColor')) {
                    <span class="org-config__field-error">{{ getErrorMessage('dominantColor') }}</span>
                  }
                </div>

                <div class="org-config__color-field">
                  <label for="secondaryColor" class="org-config__color-label">Secundario (30%)</label>
                  <div class="org-config__color-input-group">
                    <input
                      type="color"
                      [value]="form.get('secondaryColor')?.value || '#6c757d'"
                      (input)="onColorPickerChange('secondaryColor', $event)"
                      class="org-config__color-swatch" />
                    <input
                      id="secondaryColor"
                      formControlName="secondaryColor"
                      type="text"
                      class="org-config__color-text"
                      placeholder="#6c757d"
                      maxlength="7"
                      [class.org-config__input--error]="form.get('secondaryColor')?.touched && form.get('secondaryColor')?.invalid" />
                  </div>
                  @if (getErrorMessage('secondaryColor')) {
                    <span class="org-config__field-error">{{ getErrorMessage('secondaryColor') }}</span>
                  }
                </div>

                <div class="org-config__color-field">
                  <label for="accentColor" class="org-config__color-label">Acento (10%)</label>
                  <div class="org-config__color-input-group">
                    <input
                      type="color"
                      [value]="form.get('accentColor')?.value || '#B01129'"
                      (input)="onColorPickerChange('accentColor', $event)"
                      class="org-config__color-swatch" />
                    <input
                      id="accentColor"
                      formControlName="accentColor"
                      type="text"
                      class="org-config__color-text"
                      placeholder="#B01129"
                      maxlength="7"
                      [class.org-config__input--error]="form.get('accentColor')?.touched && form.get('accentColor')?.invalid" />
                  </div>
                  @if (getErrorMessage('accentColor')) {
                    <span class="org-config__field-error">{{ getErrorMessage('accentColor') }}</span>
                  }
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Save Button -->
        <button
          type="submit"
          class="org-config__btn-save"
          [disabled]="isSaving() || !hasChanges() || form.invalid">
          @if (isSaving()) {
            <span class="org-config__spinner-sm"></span>
            Guardando...
          } @else {
            <i class="bi bi-check-lg"></i>
            Guardar cambios
          }
        </button>
      </form>
    }
  </div>

  <!-- Bottom Navigation -->
  <app-admin-bottom-nav [activeTab]="'more'" />
</div>
